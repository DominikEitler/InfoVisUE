<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<meta charset="utf-8" />

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<div id="map"></div>

<script>
  var height = 1000;
  var width = 800;
  const boundaryFilter = (a, b) => a !== b;
  const textOffset = { x: 0, y: 3 };
  const greys = d3.schemeGreys[9];

  // import data
  d3.json(
    'https://gist.githubusercontent.com/clhenrick/4ebb009378a9ede30d3db672caeb9ff5/raw/bda4918592ff5e089ee4deb6650c4e5d70adb994/basemap_layers.json',
    function (basemapTopoJson) {
      const landArea = topojson.merge(
        basemapTopoJson,
        basemapTopoJson.objects['county_boundaries'].geometries
      );
      const places = topojson.feature(
        basemapTopoJson,
        basemapTopoJson.objects.osm_cities_towns
      );

      // map cropping / bounding box
      const mapFrameSpec = () => {
        const spec = {
          width: 334,
          height: 432,
          upperLeft: [403, 561],
        };

        spec.bottomRight = [
          spec.upperLeft[0] + spec.width,
          spec.upperLeft[1] + spec.height,
        ];
        return spec;
      };

      // longitude, latitude for map frame / bounding box

      var mapFrameGeoJSON = JSON.parse(
        `{"type":"Feature",
        "geometry":{"type":"LineString",
        "coordinates":[[-122.539643,38.190853],[-121.691283,37.413678]]}}`
      );

      var projection = d3
        .geoConicConformal()
        .parallels([37 + 4 / 60, 38 + 26 / 60])
        .rotate([120 + 30 / 60], 0)
        .fitSize([width, height], mapFrameGeoJSON);

      const mapFrameCoords = [
        projection.invert(mapFrameSpec().upperLeft),
        projection.invert(mapFrameSpec().bottomRight),
      ];

      function zoom(s) {
        s.call(
          d3
            .zoom()
            .on('zoom', () =>
              s.select('#map-layers').attr('transform', d3.event.transform)
            )
            .scaleExtent([1, 18])
            .translateExtent([
              [0, 0],
              [width, height],
            ])
        );
      }

      const path = d3.geoPath(projection);

      // bubble markers
      var markers = [
        { id: 649, lat: 38.06, long: -121.8 },
        { id: 2, lat: 38.063333, long: -121.851667 },
        { id: 3, lat: 38.051667, long: -121.88 },
        { id: 4, lat: 38.048333, long: -121.935 },
        { id: 5, lat: 38.06, long: -121.98 },
        { id: 6, lat: 38.065, long: -122.035 },
        { id: 7, lat: 38.048333, long: -122.096667 },
        { id: 8, lat: 38.03, long: -122.151667 },
        { id: 9, lat: 38.056667, long: -122.185 },
        { id: 10, lat: 38.06, long: -122.208333 },
        { id: 11, lat: 38.06, long: -122.266667 },
        { id: 12, lat: 38.051667, long: -122.311667 },
        { id: 13, lat: 38.028333, long: -122.37 },
        { id: 14, lat: 38.006667, long: -122.405 },
        { id: 15, lat: 37.973333, long: -122.436667 },
        { id: 16, lat: 37.916667, long: -122.446667 },
        { id: 17, lat: 37.878333, long: -122.421667 },
        { id: 18, lat: 37.846667, long: -122.421667 },
        { id: 20, lat: 37.82, long: -122.393333 },
        { id: 21, lat: 37.788333, long: -122.358333 },
        { id: 22, lat: 37.765, long: -122.358333 },
        { id: 23, lat: 37.728333, long: -122.336667 },
        { id: 24, lat: 37.698333, long: -122.338333 },
        { id: 25, lat: 37.67, long: -122.325 },
        { id: 26, lat: 37.636667, long: -122.313333 },
        { id: 27, lat: 37.618333, long: -122.291667 },
        { id: 28, lat: 37.601667, long: -122.27 },
        { id: 29, lat: 37.58, long: -122.245 },
        { id: 29.5, lat: 37.568333, long: -122.218333 },
        { id: 30, lat: 37.555, long: -122.19 },
        { id: 31, lat: 37.528333, long: -122.158333 },
        { id: 32, lat: 37.518333, long: -122.133333 },
        { id: 33, lat: 37.508333, long: -122.121667 },
        { id: 34, lat: 37.495, long: -122.098333 },
        { id: 35, lat: 37.48, long: -122.078333 },
        { id: 36, lat: 37.471667, long: -122.066667 },
        { id: 662, lat: 38.226667, long: 121.67 },
        { id: 659, lat: 38.178333, long: 121.666667 },
        { id: 655, lat: 38.121667, long: 121.701667 },
        { id: 654, lat: 38.105, long: 121.708333 },
        { id: 653, lat: 38.105, long: 121.72 },
        { id: 652, lat: 38.086667, long: 121.746667 },
        { id: 651, lat: 38.078333, long: 121.763333 },
        { id: 650, lat: 38.071667, long: 121.775 },
        { id: 411, lat: 38.096667, long: 122.058333 },
        { id: 407, lat: 38.071667, long: 122.093333 },
        { id: 405, lat: 38.048333, long: 122.123333 },
        { id: 12.5, lat: 38.04, long: 122.315 },
        { id: 19, lat: 37.818333, long: 122.471667 },
        { id: 28.5, lat: 37.596667, long: 122.235 },
      ];

      // construct svg
      var svg = d3
        .select('#map')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .call(zoom);

      // map layer group
      const g = svg.append('g').attr('id', 'map-layers');

      // background
      g.append('rect')
        .attr('width', width)
        .attr('height', height)
        .attr('x', 0)
        .attr('y', 0)
        .attr('fill', greys[1]);

      // land
      const land = g
        .append('g')
        .attr('id', 'land')
        .append('path')
        .datum(landArea)
        .attr('fill', '#fff')
        .attr('stroke-width', 0.25)
        .attr('stroke', greys[3])
        .attr('stroke-line-join', 'round')
        .attr('d', path);

      // places
      g.append('g')
        .attr('id', 'places')
        .selectAll('.place')
        .data(places.features)
        .enter()
        .append('circle')
        .classed('places', true)
        .attr('cx', (d) => path.centroid(d)[0])
        .attr('cy', (d) => path.centroid(d)[1])
        .attr('r', 1.5)
        .attr('fill', 'white')
        .attr('stroke', greys[5])
        .attr('stoke-width', 0.5);

      // labels group
      const labelsGroup = g.append('g').attr('id', 'labels');

      // labels for places
      labelsGroup
        .append('g')
        .attr('id', 'place-labels')
        .selectAll('.place-label')
        .data(places.features)
        .enter()
        .append('text')
        .classed('place-label', true)
        .attr('x', (d) => path.centroid(d)[0])
        .attr('y', (d) => path.centroid(d)[1] - textOffset.y)
        .attr('text-anchor', 'end')
        .attr('fill', greys[7])
        .style('font', '7px sans-serif')
        .text((d) => d.properties.name);

      // tooltip
      var Tooltip = d3
        .select('#map')
        .append('div')
        .attr('class', 'tooltip')
        .style('position', 'absolute')
        .style('opacity', 1)
        .style('background-color', 'white')
        .style('border', 'solid')
        .style('border-width', '2px')
        .style('border-radius', '5px')
        .style('padding', '5px');

      // tooltip hover function
      var mouseover = function (d) {
        Tooltip.style('opacity', 1);
      };
      var mousemove = function (d) {
        Tooltip.html(
          d.id + '<br>' + 'long: ' + d.long + '<br>' + 'lat: ' + d.lat
        )
          .style('left', d3.mouse(this)[0] + 10 + 'px')
          .style('top', d3.mouse(this)[1] + 2 + 'px');
      };
      var mouseleave = function (d) {
        Tooltip.style('opacity', 0);
      };

      // circles
      g.selectAll('myCircles')
        .data(markers)
        .enter()
        .append('circle')
        .attr('cx', (d) => projection([d.long, d.lat])[0])
        .attr('cy', (d) => projection([d.long, d.lat])[1])
        .attr('r', 10)
        .style('fill', '69b3a2')
        .attr('stroke', '#69b3a2')
        .attr('stroke-width', 3)
        .attr('fill-opacity', 0.4)
        .on('mouseover', mouseover)
        .on('mousemove', mousemove)
        .on('mouseleave', mouseleave);
    }
  );
</script>
